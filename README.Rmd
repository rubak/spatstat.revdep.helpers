---
title: "Helper functions to update to new spatstat structure"
author: "Ege Rubak"
output: github_document
---

These are **very rough** implementations that work to some extend on my local 
Ubuntu 20.04 machine. **Several system commands are used that probably don't
work on Windows.** It should be relatively easy to adapt to Windows, but I won't 
do it unless I get specific requests and have time to do it.

## How do I use it for my package(s)?

1. Clone this git repository or download the contents and put it in a fresh directory on your computer.
2. Change the variable `pkg` below to you package name(s) (one at a time if you have several)
3. Run the code in this `README` with your value of `pkg`, but skip the part about downloading sources from CRAN and unpacking. Instead put the source code of your packages in a subdirectory called `sources` as described below.

## Getting started

We need the new spatstat packages:
```{r}
inst_pkgs <- rownames(installed.packages())
if(!is.element("spatstat.geom", inst_pkgs)){
  install.packages("spatstat.geom")
}
if(!is.element("spatstat.core", inst_pkgs)){
  install.packages("spatstat.core")
}
if(!is.element("spatstat.linnet", inst_pkgs)){
  remotes::install_github("spatstat/spatstat.linnet")
}
```


Directories used under local directory (the one you cloned in or created yourself):

- `downloads`: Where the tarball of the source code lives.
- `sources`: Where the original source code of the package(s) to be updated lives (unpacked from `downloads` in my example).
- `updates`: Where the generated updated source code live.
- `builds`: Where the new builds of updated sources live.
- `checks_original`: Where check results for the original package live (not used here).
- `checks_updates`: Where check results for the updated package live (not used here).

A few global variables are used:
```{r}
DIR <- getwd()
DEPENDS <- tools::package_dependencies("spatstat", which = "Depends", reverse = TRUE)$spatstat
```

## Example usage

We will use `ppmlasso` as an example of how to update the sources:

```{r}
pkg <- "ppmlasso"
```

If your package `Depends` on spatstat we also need the new umbrella spatstat 
installed :
```{r}
if(pkg %in% DEPENDS && packageVersion("spatstat") < "1.65"){
  remotes::install_github("baddstats/spatstat")
}
```


Source the helper functions:
```{r}
source("helpers.R")
```

Download into `downloads` from CRAN and copy to `sources`. **You probably just 
want to manually make the directory `sources` and add a directory with your 
package code there.**

```{r}
download_from_cran(pkg)
```

Check that we have the files the right place:
```{r}
list.files("sources")
list.files(file.path("sources", pkg))
```

Make a copy of the `sources` in `updates` to work on:
```{r}
dir.create("updates", showWarnings = FALSE)
file.copy(file.path("sources", pkg), "updates", recursive = TRUE)
```

You could check the current version of the package with this command, but in 
particular for packages that `Depends` on spatstat this is problematic since you
need the old spatstat to check the current version and the new umbrella spatstat
to check the updated version.
```{r eval=FALSE}
check_pkg(pkg, tar_dir = "downloads", check_dir = "checks_original")
```

There are a bunch of helper functions updating `NAMESPACE`, `DESCRIPTION`, 
source files, man files, etc. They are all wrapped in a single function 
`dep_update()` which updates the sources, but we need to globally define a 
`data.frame` called `fundf` with all the functions of the spatstat sub-packages 
first (generated by `spst_fun_df()`):

```{r}
fundf <- spst_fun_df()
dep_update(pkg, download = FALSE, check_original = FALSE,
           fix_src = TRUE, build = FALSE, check_updates = FALSE)
```

Then you can build the sources:

```{r}
buildDIR <- file.path(DIR, "builds")
dir.create(buildDIR, showWarnings = FALSE)
system(paste("cd", buildDIR, "; R CMD build", file.path(DIR, "updates", pkg)))
```

If you have the package `rcmdcheck` you can check the newly build sources like
this:

```{r}
check_pkg(pkg, tar_dir = "builds", check_dir = "checks_updates")
```
