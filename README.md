Helper functions to update to new spatstat structure
================
Ege Rubak

These are **very rough** implementations that work to some extend on my
local Ubuntu 20.04 machine. **Several system commands are used that
probably don’t work on Windows.** It should be relatively easy to adapt
to Windows, but I won’t do it unless I get specific requests and have
time to do it.

## How do I use it for my package(s)?

1.  Clone this git repository or download the contents and put it in a
    fresh directory on your computer.
2.  Change the variable `pkg` below to you package name(s) (one at a
    time if you have several)
3.  Run the code in this `README` with your value of `pkg`, but skip the
    part about downloading sources from CRAN and unpacking. Instead put
    the source code of your packages in a subdirectory called `sources`
    as described below.

## Getting started

We need the new spatstat packages:

``` r
need_pkgs <- c("remotes", "spatstat.geom", "spatstat.core", "spatstat.linnet")
inst_pkgs <- rownames(installed.packages())
miss_pkgs <- setdiff(need_pkgs, inst_pkgs)
if(length(miss_pkgs)>0){
  install.packages(miss_pkgs)
}
remotes::install_github("baddstats/spatstat")
```

    ## Using github PAT from envvar GITHUB_PAT

    ## Skipping install of 'spatstat' from a github remote, the SHA1 (578a1b70) has not changed since last install.
    ##   Use `force = TRUE` to force installation

Directories used under local directory (the one you cloned into or
created yourself – **make sure you run the code with this as working
directory**):

-   `downloads`: Where the tarball of the source code lives.
-   `sources`: Where the original source code of the package(s) to be
    updated lives (unpacked from `downloads` in my example).
-   `updates`: Where the generated updated source code live.
-   `builds`: Where the new builds of updated sources live.
-   `checks_original`: Where check results for the original package live
    (not used here).
-   `checks_updates`: Where check results for the updated package live
    (not used here).

A few global variables are used:

``` r
DIR <- getwd()
DEPENDS <- tools::package_dependencies("spatstat", which = "Depends", reverse = TRUE)$spatstat
IMPORTS <- tools::package_dependencies("spatstat", which = "Imports", reverse = TRUE)$spatstat
```

## Example usage

We will use `ppmlasso` as an example of how to update the sources:

``` r
pkg <- "ppmlasso"
```

Source the helper functions:

``` r
source("helpers.R")
```

Download into `downloads` from CRAN and copy to `sources`. **You
probably just want to manually make the directory `sources` and add a
directory with your package code there.**

``` r
download_from_cran(pkg)
```

Check that we have the files the right place:

``` r
list.files("sources")
```

    ## [1] "ppmlasso"

``` r
list.files(file.path("sources", pkg))
```

    ## [1] "data"        "DESCRIPTION" "inst"        "man"         "MD5"        
    ## [6] "NAMESPACE"   "R"

Make a copy of the `sources` in `updates` to work on:

``` r
dir.create("updates", showWarnings = FALSE)
file.copy(file.path("sources", pkg), "updates", recursive = TRUE)
```

    ## [1] TRUE

You could check the current version of the package with this command,
but in particular for packages that `Depends` on spatstat this is
problematic since you need the old spatstat to check the current version
and the new umbrella spatstat to check the updated version.

``` r
check_pkg(pkg, tar_dir = "downloads", check_dir = "checks_original")
```

There are a bunch of helper functions updating `NAMESPACE`,
`DESCRIPTION`, source files, man files, etc. They are all wrapped in a
single function `dep_update()` which updates the sources, but we need to
globally define a `data.frame` called `fundf` with all the functions of
the spatstat sub-packages first (generated by `spst_fun_df()`):

``` r
fundf <- spst_fun_df()
```

    ## Loading required package: spatstat.data

    ## Loading required package: spatstat.geom

    ## spatstat.geom 1.65-5

    ## Loading required package: spatstat.core

    ## Loading required package: nlme

    ## Loading required package: rpart

    ## spatstat.core 1.65-1

``` r
dep_update(pkg, download = FALSE, check_original = FALSE,
           fix_src = TRUE, build = FALSE, check_updates = FALSE)
```

    ## Warning in system(paste0("grep -lr \"library(.*spatstat\" ", DIR, "/updates/", :
    ## running command 'grep -lr "library(.*spatstat" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## Warning in system(paste0("grep -lr \"require(.*spatstat\" ", DIR, "/updates/", :
    ## running command 'grep -lr "require(.*spatstat" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## Warning in system(paste0("grep -lr \"requireNamespace(.*spatstat\" ",
    ## DIR, : running command 'grep -lr "requireNamespace(.*spatstat" /home/rubak/
    ## spatstat.revdepcheck/spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## [1] "found 0 files"

    ## Warning in system(paste0("grep -rl \"lengths.psp\" ", DIR, "/updates/", :
    ## running command 'grep -rl "lengths.psp" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## Warning in system(paste0("grep -lr \"spatstat::\" ", DIR, "/updates/", pkg), :
    ## running command 'grep -lr "spatstat::" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## [1] "ppmlasso : found 0 files"
    ## [1] "/home/rubak/spatstat.revdepcheck/spatstat.revdep.helpers/updates/ppmlasso/NAMESPACE: line 1: import(spatstat,methods)"

    ## Warning in system(paste0("grep -lr \"link\\[spatstat\" ", DIR, "/updates/", :
    ## running command 'grep -lr "link\[spatstat" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso' had status 1

    ## [1] "ppmlasso : found 0 files"

    ## Warning in system(paste0("grep -l \"register_s3_method.*spatstat\" ",
    ## DIR, : running command 'grep -l "register_s3_method.*spatstat" /home/rubak/
    ## spatstat.revdepcheck/spatstat.revdep.helpers/updates/ppmlasso/R/*.R' had status
    ## 1

    ## [1] "ppmlasso : found 0 files"

    ## Warning in system(paste0("grep -l \"import.*spatstat\" ", DIR, "/updates/", :
    ## running command 'grep -l "import.*spatstat" /home/rubak/spatstat.revdepcheck/
    ## spatstat.revdep.helpers/updates/ppmlasso/R/*.R' had status 1

Then you can build the sources:

``` r
buildDIR <- file.path(DIR, "builds")
dir.create(buildDIR, showWarnings = FALSE)
system(paste("cd", buildDIR, "; R CMD build", file.path(DIR, "updates", pkg)))
```

If you have the package `rcmdcheck` you can check the newly build
sources like this:

``` r
check_pkg(pkg, tar_dir = "builds", check_dir = "checks_updates")
```

    ## Registered S3 method overwritten by 'cli':
    ##   method     from         
    ##   print.boxx spatstat.geom

    ## ── R CMD check ─────────────────────────────────────────────────────────────────
    ## * using log directory ‘/home/rubak/spatstat.revdepcheck/spatstat.revdep.helpers/checks_updates/ppmlasso.Rcheck’
    ## * using R version 4.0.3 (2020-10-10)
    ## * using platform: x86_64-pc-linux-gnu (64-bit)
    ## * using session charset: UTF-8
    ## * using option ‘--no-manual’
    ## * checking for file ‘ppmlasso/DESCRIPTION’ ... OK
    ## * checking extension type ... Package
    ## * this is package ‘ppmlasso’ version ‘1.1’
    ## * checking package namespace information ... OK
    ## * checking package dependencies ... OK
    ## * checking if this is a source package ... OK
    ## * checking if there is a namespace ... OK
    ## * checking for executable files ... OK
    ## * checking for hidden files and directories ... OK
    ## * checking for portable file names ... OK
    ## * checking for sufficient/correct file permissions ... OK
    ## * checking whether package ‘ppmlasso’ can be installed ... OK
    ## * checking installed package size ... OK
    ## * checking package directory ... OK
    ## * checking DESCRIPTION meta-information ... OK
    ## * checking top-level files ... OK
    ## * checking for left-over files ... OK
    ## * checking index information ... OK
    ## * checking package subdirectories ... OK
    ## * checking R files for non-ASCII characters ... OK
    ## * checking R files for syntax errors ... OK
    ## * checking whether the package can be loaded ... OK
    ## * checking whether the package can be loaded with stated dependencies ... OK
    ## * checking whether the package can be unloaded cleanly ... OK
    ## * checking whether the namespace can be loaded with stated dependencies ... OK
    ## * checking whether the namespace can be unloaded cleanly ... OK
    ## * checking loading without being on the library search path ... OK
    ## * checking dependencies in R code ... OK
    ## * checking S3 generic/method consistency ... OK
    ## * checking replacement functions ... OK
    ## * checking foreign function calls ... OK
    ## * checking R code for possible problems ... NOTE
    ## env.var: no visible global function definition for ‘flush.console’
    ## findres: no visible global function definition for ‘as.formula’
    ## findres: no visible global function definition for ‘glm’
    ## findres: no visible global function definition for ‘poisson’
    ## point.interactions: no visible global function definition for
    ##   ‘flush.console’
    ## ppm.ss: no visible global function definition for ‘as.formula’
    ## ppm.ss: no visible global function definition for ‘terms’
    ## ppm.ss: no visible global function definition for ‘glm’
    ## ppm.ss: no visible global function definition for ‘poisson’
    ## ppm.ss: no visible global function definition for ‘quasi’
    ## ppmlasso: no visible global function definition for ‘as.formula’
    ## ppmlasso: no visible global function definition for ‘model.frame’
    ## ppmlasso: no visible global function definition for ‘is.empty.model’
    ## ppmlasso: no visible global function definition for ‘model.matrix’
    ## ppmlasso: no visible binding for global variable ‘contrasts’
    ## ppmlasso: no visible global function definition for ‘poisson’
    ## ppmlasso: no visible global function definition for ‘glm’
    ## ppmlasso: no visible global function definition for ‘flush.console’
    ## predict.ppmlasso: no visible global function definition for
    ##   ‘as.formula’
    ## predict.ppmlasso: no visible binding for global variable ‘var’
    ## predict.ppmlasso: no visible global function definition for ‘rnorm’
    ## predict.ppmlasso: no visible global function definition for
    ##   ‘model.frame’
    ## predict.ppmlasso: no visible global function definition for
    ##   ‘is.empty.model’
    ## predict.ppmlasso: no visible global function definition for
    ##   ‘model.matrix’
    ## predict.ppmlasso: no visible binding for global variable ‘contrasts’
    ## predict.ppmlasso: no visible global function definition for ‘sd’
    ## score.int: no visible global function definition for ‘glm’
    ## single.lasso: no visible global function definition for ‘flush.console’
    ## standardise.X: no visible binding for global variable ‘sd’
    ## predict,ppmlasso: no visible global function definition for
    ##   ‘as.formula’
    ## predict,ppmlasso: no visible binding for global variable ‘var’
    ## predict,ppmlasso: no visible global function definition for ‘rnorm’
    ## predict,ppmlasso: no visible global function definition for
    ##   ‘model.frame’
    ## predict,ppmlasso: no visible global function definition for
    ##   ‘is.empty.model’
    ## predict,ppmlasso: no visible global function definition for
    ##   ‘model.matrix’
    ## predict,ppmlasso: no visible binding for global variable ‘contrasts’
    ## predict,ppmlasso: no visible global function definition for ‘sd’
    ## Undefined global functions or variables:
    ##   as.formula contrasts flush.console glm is.empty.model model.frame
    ##   model.matrix poisson quasi rnorm sd terms var
    ## Consider adding
    ##   importFrom("stats", "as.formula", "contrasts", "glm", "is.empty.model",
    ##              "model.frame", "model.matrix", "poisson", "quasi", "rnorm",
    ##              "sd", "terms", "var")
    ##   importFrom("utils", "flush.console")
    ## to your NAMESPACE file.
    ## * checking Rd files ... OK
    ## * checking Rd metadata ... OK
    ## * checking Rd cross-references ... OK
    ## * checking for missing documentation entries ... OK
    ## * checking for code/documentation mismatches ... OK
    ## * checking Rd \usage sections ... OK
    ## * checking Rd contents ... OK
    ## * checking for unstated dependencies in examples ... OK
    ## * checking contents of ‘data’ directory ... OK
    ## * checking data for non-ASCII characters ... OK
    ## * checking data for ASCII and uncompressed saves ... OK
    ## * checking examples ... OK
    ## * DONE
    ## 
    ## Status: 1 NOTE
    ## See
    ##   ‘/home/rubak/spatstat.revdepcheck/spatstat.revdep.helpers/checks_updates/ppmlasso.Rcheck/00check.log’
    ## for details.
